<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magical Girl Survival Simulator - EX Complete</title>
    <style>
        :root {
            --pastel-pink: #ffd1dc;
            --deep-pink: #ff1493;
            --black: #0d0609;
            --blood-red: #8a0303;
        }
        body {
            background-color: var(--black);
            color: var(--pastel-pink);
            font-family: 'MS Mincho', 'Hiragino Mincho ProN', serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #game-container {
            width: 1000px;
            height: 600px;
            background: linear-gradient(180deg, #1a0b12 0%, #000000 100%);
            border: 2px solid var(--deep-pink);
            box-shadow: 0 0 30px rgba(255, 20, 147, 0.3);
            position: relative;
            display: flex;
            overflow: hidden;
        }

        .scanlines {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 255, 0, 0.06));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            z-index: 100;
        }

        #game-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            border-right: 1px solid var(--deep-pink);
        }

        #status-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: rgba(255, 20, 147, 0.15);
            border-bottom: 1px solid var(--deep-pink);
            font-size: 1.1rem;
            z-index: 10;
        }

        #ranking-panel {
            width: 250px;
            background: rgba(13, 6, 9, 0.8);
            padding: 15px;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .ranking-title { text-align: center; border-bottom: 1px solid var(--pastel-pink); margin-bottom: 10px; color: var(--deep-pink); font-weight: bold; }
        .ranking-item { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85rem;}
        .ranking-item.player { color: #fff; text-shadow: 0 0 5px var(--deep-pink); font-weight: bold; }

        #main-view { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; }
        #message-window {
            background: rgba(255, 209, 220, 0.1);
            border: 1px solid var(--deep-pink);
            padding: 20px;
            min-height: 100px;
            font-size: 1.2rem;
            margin-bottom: 15px;
            z-index: 10;
        }

        #choices-container { display: flex; flex-direction: column; gap: 8px; z-index: 10; }
        .choice-btn {
            background: rgba(0, 0, 0, 0.7);
            color: var(--pastel-pink);
            border: 1px solid var(--pastel-pink);
            padding: 12px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        .choice-btn:hover { background: var(--deep-pink); color: #fff; }

        #setup-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--black);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            box-sizing: border-box;
        }
        .setup-group { margin-bottom: 20px; text-align: center; width: 100%; }
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #333; }
        .setup-btn { background: #000; border: 1px solid var(--pastel-pink); color: var(--pastel-pink); padding: 5px; cursor: pointer; font-size: 0.8rem; }
        .setup-btn.active { background: var(--deep-pink); color: white; border-color: white; }
        .start-btn { padding: 15px 40px; font-size: 1.5rem; background: var(--deep-pink); color: white; border: none; cursor: pointer; margin-top: 20px; }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆã‚¹ãƒ”ãƒ¼ãƒ‰ãƒ»éŸ³é‡è¨­å®šï¼‰ */
        #speed-ctrl {
            padding: 8px 20px;
            background: rgba(0,0,0,0.5);
            font-size: 0.8rem;
            display: flex;
            gap: 15px;
            align-items: center;
            border-top: 1px solid #333;
            flex-wrap: wrap;
        }
        .volume-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        input[type="range"] {
            cursor: pointer;
            accent-color: var(--deep-pink);
            height: 4px;
            vertical-align: middle;
        }

        #fav-popup {
            position: absolute;
            top: 50%; left: 40%;
            transform: translate(-50%, -50%);
            width: 50%;
            background: rgba(0, 0, 0, 0.95);
            border: 3px dashed var(--pastel-pink);
            padding: 20px;
            text-align: center;
            display: none;
            z-index: 150;
        }

        @keyframes flashRed {
            0% { box-shadow: inset 0 0 0px var(--blood-red); }
            50% { box-shadow: inset 0 0 100px var(--blood-red); background-color: rgba(138, 3, 3, 0.4); }
            100% { box-shadow: inset 0 0 0px var(--blood-red); }
        }
        .flash-red-anim { animation: flashRed 0.3s 3; }
        .glitch-anim { animation: glitch 0.2s linear infinite; color: red; }
        @keyframes glitch { 0%, 100% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(2px, -2px); } }

        .restart-btn {
            background: transparent; color: white; border: 1px solid white; padding: 10px 20px; cursor: pointer; font-family: inherit; margin-top: 20px;
        }
        .restart-btn:hover { background: white; color: black; }
    </style>
</head>
<body>

<audio id="bgm" src="bgm.mp3" loop></audio>

<div id="game-container">
    <div class="scanlines"></div>

    <div id="setup-screen">
        <h1 style="color:var(--deep-pink)">Magical Girl Survival</h1>
        <div class="setup-group">
            <p>é›£æ˜“åº¦ï¼ˆãƒ©ã‚¤ãƒãƒ«ã®å¼·ã•ï¼‰ã‚’é¸æŠã—ã¦ã½ã‚“ï¼š</p>
            <button class="setup-btn difficulty-btn" onclick="setDifficulty('easy', this)">ã‚¤ãƒ¼ã‚¸ãƒ¼ï¼ˆæ¿€ç”˜ï¼‰</button>
            <button class="setup-btn difficulty-btn active" onclick="setDifficulty('normal', this)">ãƒãƒ¼ãƒãƒ«</button>
            <button class="setup-btn difficulty-btn" onclick="setDifficulty('hard', this)">ãƒãƒ¼ãƒ‰ï¼ˆçµ¶æœ›ï¼‰</button>
        </div>
        <div class="setup-group">
            <p>æ“ä½œã™ã‚‹é­”æ³•å°‘å¥³ã‚’é¸ã‚“ã§ã½ã‚“ï¼š</p>
            <div id="char-selection" class="char-grid"></div>
        </div>
        <button class="start-btn" onclick="startGame()">å¥‘ç´„ã™ã‚‹ã½ã‚“ï¼</button>
    </div>
    
    <div id="game-main">
        <div id="status-bar">
            <div>ğŸ¬: <span id="candy-display">50</span></div>
            <div>ğŸ§š: <span id="survivor-display">16</span>/16</div>
            <div>â± ç¬¬<span id="week-display">1</span>é€± <span id="day-display">æœˆ</span></div>
        </div>
        <div id="main-view">
            <div id="message-window">...</div>
            <div id="choices-container"></div>
        </div>
        <div id="speed-ctrl">
            ãƒ¢ãƒ¼ãƒ‰: <span id="mode-display">NORMAL</span> | 
            <label><input type="checkbox" id="speed-toggle" onchange="toggleSpeed()"> 2å€é€Ÿãƒ¢ãƒ¼ãƒ‰</label> |
            <label><input type="checkbox" id="bgm-toggle" onchange="toggleBGM()" checked> BGMå†ç”Ÿ</label>
            <div class="volume-container">
                ğŸ”ˆ<input type="range" id="volume-slider" min="0" max="0.5" step="0.01" value="0.05" oninput="changeVolume(this.value)">ğŸ”Š
            </div>
        </div>
    </div>
    <div id="ranking-panel">
        <div class="ranking-title">ã‚­ãƒ£ãƒ³ãƒ‡ã‚£ãƒ¼æ‰€æŒæ•°</div>
        <div id="ranking-list"></div>
    </div>
    <div id="fav-popup">
        <div style="font-size:2rem">ğŸ§š</div>
        <div id="fav-message"></div>
        <button onclick="closeFav()" style="margin-top:10px">åˆ†ã‹ã£ãŸã½ã‚“</button>
    </div>
</div>

<script>
    let state = {
        candies: 50,
        week: 1,
        dayIndex: 0,
        survivors: 16,
        playerName: "",
        magicName: "",
        isGameOver: false,
        gameSpeed: 1,
        difficulty: 'normal',
        difficultyMults: { easy: 0.6, normal: 1.0, hard: 1.5 },
        characterList: [
            { name: "ãƒãƒ¼ãƒ‰ã‚´ã‚¢ãƒ»ã‚¢ãƒªã‚¹", magic: "ã€ã©ã‚“ãªæ€ªæˆ‘ã‚’ã—ã¦ã‚‚ã™ãã«æ²»ã‚‹ã‚ˆã€" },
            { name: "ã‚¹ãƒãƒ¼ãƒ›ãƒ¯ã‚¤ãƒˆ", magic: "ã€å›°ã£ã¦ã„ã‚‹äººã®å¿ƒã®å£°ãŒèã“ãˆã‚‹ã‚ˆã€" },
            { name: "ãƒªãƒƒãƒ—ãƒ«", magic: "ã€æŠ•ã’ãŸã‚‚ã®ãŒå¿…ãšçš„ã«å½“ãŸã‚‹ã‚ˆã€" },
            { name: "ãƒ©ãƒ»ãƒ”ãƒ¥ã‚»ãƒ«", magic: "ã€å‰£ã®å¤§ãã•ã‚’è‡ªç”±ã«å¤‰ãˆã‚‰ã‚Œã‚‹ã‚ˆã€" },
            { name: "ãƒˆãƒƒãƒ—ã‚¹ãƒ”ãƒ¼ãƒ‰", magic: "ã€çŒ›ã‚¹ãƒ”ãƒ¼ãƒ‰ã§ç©ºã‚’é£›ã¶é­”æ³•ã®ç®’ã‚’ä½¿ã†ã‚ˆã€" },
            { name: "ã‚«ãƒ©ãƒŸãƒ†ã‚£ãƒ»ãƒ¡ã‚¢ãƒª", magic: "ã€æŒã£ã¦ã„ã‚‹æ­¦å™¨ã‚’ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã•ã›ã‚‹ã‚ˆã€" },
            { name: "ãƒã‚¸ã‚«ãƒ«ãƒ­ã‚¤ãƒ‰44", magic: "ã€æœªæ¥ã®ä¾¿åˆ©ãªé“å…·ã‚’æ¯æ—¥ä¸€ã¤å‡ºã›ã‚‹ã‚ˆã€" },
            { name: "ãƒ¦ãƒŠã‚¨ãƒ«", magic: "ã€å¥½ããªç”Ÿãç‰©ã«å¤‰èº«ã§ãã‚‹ã‚ˆã€" },
            { name: "ãƒŸãƒŠã‚¨ãƒ«", magic: "ã€å¥½ããªç‰©ï¼ˆç„¡æ©Ÿç‰©ï¼‰ã«å¤‰èº«ã§ãã‚‹ã‚ˆã€" },
            { name: "ãŸã¾", magic: "ã€è‰²ã‚“ãªã‚‚ã®ã«ç´ æ—©ãç©´ã‚’é–‹ã‘ã‚‰ã‚Œã‚‹ã‚ˆã€" },
            { name: "ã­ã‚€ã‚Šã‚“", magic: "ã€ä»–äººã®å¤¢ã®ä¸­ã«å…¥ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã€" },
            { name: "ãƒ«ãƒ¼ãƒ©", magic: "ã€ç›®ã®å‰ã®ç›¸æ‰‹ã«ã©ã‚“ãªå‘½ä»¤ã§ã‚‚èã‹ã›ã‚‰ã‚Œã‚‹ã‚ˆã€" },
            { name: "ã‚¹ã‚¤ãƒ ã‚¹ã‚¤ãƒ ", magic: "ã€ã©ã‚“ãªã‚‚ã®ã«ã§ã‚‚æ°´ã¿ãŸã„ã«æ½œã‚Šè¾¼ã‚ã‚‹ã‚ˆã€" },
            { name: "æ£®ã®éŸ³æ¥½å®¶ã‚¯ãƒ©ãƒ ãƒ™ãƒªãƒ¼", magic: "ã€éŸ³ã‚’è‡ªç”±è‡ªåœ¨ã«æ“ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã€" },
            { name: "ã‚·ã‚¹ã‚¿ãƒ¼ãƒ»ãƒŠãƒŠ", magic: "ã€å¥½ããªäººã®èƒ½åŠ›ã‚’é£›èºçš„ã«é«˜ã‚ã‚‹ã‚ˆã€" },
            { name: "ãƒ´ã‚§ã‚¹ãƒ»ã‚¦ã‚£ãƒ³ã‚¿ãƒ¼ãƒ—ãƒªã‚ºãƒ³", magic: "ã€ä½•ã‚‚ãªã„ã¨ã“ã‚ã«å£ã‚’ä½œã‚Šå‡ºã›ã‚‹ã‚ˆã€" }
        ],
        npcScores: {}
    };

    let npcList = [];
    const days = ["æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘"];
    let commonEvents = [];

    // --- BGM & éŸ³é‡åˆ¶å¾¡ ---
    const bgm = document.getElementById('bgm');
    bgm.volume = 0.15; 

    function toggleBGM() {
        const isChecked = document.getElementById('bgm-toggle').checked;
        if (isChecked) {
            bgm.play().catch(e => console.log("å†ç”Ÿåˆ¶é™"));
        } else {
            bgm.pause();
        }
    }

    function changeVolume(val) {
        bgm.volume = val;
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã—ãŸã¨ãã€ã‚‚ã—ãƒã‚§ãƒƒã‚¯ãŒå¤–ã‚Œã¦ã„ãŸã‚‰å†ç”Ÿã™ã‚‹ã‚ˆã†ã«ã™ã‚‹ï¼ˆåˆ©ä¾¿æ€§ã®ãŸã‚ï¼‰
        if (val > 0 && !document.getElementById('bgm-toggle').checked) {
            document.getElementById('bgm-toggle').checked = true;
            bgm.play();
        }
    }

    // --- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
    fetch("commonEvents.json")
        .then(res => res.json())
        .then(data => {
            commonEvents = data;
            while (commonEvents.length < 40 && commonEvents.length > 0) {
                const base = commonEvents[Math.floor(Math.random()*commonEvents.length)];
                commonEvents.push({
                    ...base,
                    text: "ã€å†ç™ºã€‘" + base.text
                });
            }
        })
        .catch(err => {
            console.error("commonEvents.json èª­ã¿è¾¼ã¿å¤±æ•—");
            commonEvents = [{ text: "è¡—ã‚’ãƒ‘ãƒˆãƒ­ãƒ¼ãƒ«ã—ãŸã€‚", choices: [{ text: "é£´ã‚’æ¢ã™", candy: 10, survival: -10, msg: "å°‘ã—è¦‹ã¤ã‹ã£ãŸã€‚" }] }];
        });

    const mgEvents = [
        { text: "ã€é­é‡ã€‘ãƒªãƒƒãƒ—ãƒ«ãŒç‰¹è¨“ã‚’ã—ã¦ã„ã‚‹ã€‚", choices: [{ text: "ä¸€ç·’ã«è¨“ç·´ã™ã‚‹", candy: 10, survival: -25, msg: "æŠ€è¡“ã¯ä¸ŠãŒã£ãŸãŒç–²å¼Šã—ãŸã€‚" }, { text: "çš„ã«é­”æ³•ã‚’å‹•ã‹ã™", candy: 18, survival: -30, msg: "å½¼å¥³ã¯æ€’ã£ãŸãŒé£´ã‚’å¾—ãŸã€‚" }, { text: "å·®ã—å…¥ã‚Œã«é£´ã‚’æ¸¡ã™", candy: -25, survival: 45, msg: "å°‘ã—ä»²è‰¯ããªã‚ŒãŸã€‚" }] },
        { text: "ã€äº¤æµã€‘ã‚¹ãƒãƒ¼ãƒ›ãƒ¯ã‚¤ãƒˆãŒå›°ã£ã¦ã„ã‚‹äººã®å£°ã‚’èã„ã¦ã„ã‚‹ã€‚", choices: [{ text: "æ‰‹ä¼ã„ã‚’ç”³ã—å‡ºã‚‹", candy: 20, survival: -20, msg: "äºŒäººã§å¤šãã®äººã‚’æ•‘ã£ãŸã€‚" }, { text: "å½¼å¥³ã®ä»£ã‚ã‚Šã«é£´ã‚’é›†ã‚ã‚‹", candy: 30, survival: -45, msg: "æ„Ÿè¬ã•ã‚ŒãŸãŒå±é™ºãŒå¢—ã—ãŸã€‚" }, { text: "é ãã‹ã‚‰é™è¦³ã™ã‚‹", candy: 0, survival: 10, msg: "å¿ƒãŒæ´—ã‚ã‚ŒãŸã€‚" }] },
        { text: "ã€å±æ©Ÿã€‘ã‚«ãƒ©ãƒŸãƒ†ã‚£ãƒ»ãƒ¡ã‚¢ãƒªãŒé…”ã£ã¦æš´ã‚Œã¦ã„ã‚‹ã€‚", choices: [{ text: "æ­£é¢ã‹ã‚‰æ­¢ã‚ã‚‹", candy: 40, survival: -80, msg: "æ¿€æˆ¦ã®æœ«ã€æ²ˆé™åŒ–ã•ã›ãŸã€‚" }, { text: "é…’ã«ç¡çœ è–¬ã‚’æ··ãœã‚‹", candy: 15, survival: -30, msg: "ã†ã¾ãçœ ã‚‰ã›ãŸã€‚" }, { text: "é£´ã‚’ç½®ã„ã¦å»ã‚‹", candy: -45, survival: 60, msg: "åº—ä¸»ã‹ã‚‰æ·±ãæ„Ÿè¬ã•ã‚ŒãŸã€‚" }] },
        { text: "ã€å–å¼•ã€‘ãƒã‚¸ã‚«ãƒ«ãƒ­ã‚¤ãƒ‰44ãŒæ€ªã—ã„æ©Ÿæ¢°ã‚’å£²ã£ã¦ã„ã‚‹ã€‚", choices: [{ text: "é£´å¢—æ®–æ©Ÿã‚’è²·ã†", candy: -50, survival: 15, msg: "å³åº§ã«çˆ†ç™ºã—ãŸï¼" }, { text: "ã‚·ãƒ¼ãƒ«ãƒ‰ã‚’è²·ã†", candy: -35, survival: 65, msg: "é ‘ä¸ˆãªå®ˆã‚Šã‚’å¾—ãŸã€‚" }, { text: "å½¼å¥³ã‚’ã‚¹ã‚¯ãƒ©ãƒƒãƒ—ã«ã™ã‚‹", candy: 35, survival: -60, msg: "ãƒ‘ãƒ¼ãƒ„ã‚’é£´ã¨äº¤æ›ã—ãŸã€‚" }] },
        { text: "ã€å¼·è¥²ã€‘ã‚¹ã‚¤ãƒ ã‚¹ã‚¤ãƒ ãŒåºŠã‹ã‚‰å¿ã³å¯„ã£ã¦ããŸï¼", choices: [{ text: "å…¨åŠ›ã§ç©ºã¸é€ƒã’ã‚‹", candy: 0, survival: 20, msg: "å±æ©Ÿä¸€é«ªã§å›é¿ã—ãŸã€‚" }, { text: "åºŠã‚’é­”æ³•ã§ç¡¬è³ªåŒ–ã•ã›ã‚‹", candy: 15, survival: -20, msg: "å½¼å¥³ã‚’é–‰ã˜è¾¼ã‚ã¦è¿½ã„æ‰•ã£ãŸã€‚" }, { text: "æŒã£ã¦ã„ãŸé£´ã‚’ã™ã¹ã¦å·®ã—å‡ºã™", candy: -80, survival: 150, msg: "è¦‹é€ƒã—ã¦ã‚‚ã‚‰ãˆãŸãŒã€ã»ã¼å…¨ã¦ã‚’å¤±ã£ãŸã€‚" }] },
        { text: "ã€èª˜æƒ‘ã€‘ã‚¯ãƒ©ãƒ ãƒ™ãƒªãƒ¼ãŒæ¼”å¥ä¼šã‚’é–‹ã„ã¦ã„ã‚‹ã€‚", choices: [{ text: "è´ãå…¥ã‚‹", candy: 0, survival: -60, msg: "æ—‹å¾‹ã«å½“ã¦ã‚‰ã‚Œã€è¡°å¼±ã—ãŸã€‚" }, { text: "æ‹æ‰‹ã¨å…±ã«é£´ã‚’è´ˆã‚‹", candy: -30, survival: 60, msg: "ã€Œå¼·ã„é­‚ã€ã ã¨èªã‚ã‚‰ã‚ŒãŸã€‚" }, { text: "æ¼”å¥ã‚’é­”æ³•ã§å¦¨å®³ã™ã‚‹", candy: 30, survival: -80, msg: "æ®ºã—åˆã„ã«ç™ºå±•ã—ãŸã€‚" }] },
        { text: "ã€äº‹æ•…ã€‘ãŸã¾ãŒèª¤ã£ã¦è¡—ã‚’ç©´ã ã‚‰ã‘ã«ã—ã¦ã—ã¾ã£ãŸã€‚", choices: [{ text: "ä¸€ç·’ã«åŸ‹ã‚æˆ»ã™", candy: 5, survival: 25, msg: "ãŸã¾ã¯æ³£ã„ã¦å–œã‚“ã ã€‚" }, { text: "ç©´ã‚’åˆ©ç”¨ã—ã¦ç½ ã‚’ä½œã‚‹", candy: 25, survival: -45, msg: "åŠ¹ç‡çš„ã«ä»–è€…ã‹ã‚‰å¥ªãˆãŸã€‚" }, { text: "é­”æ³•ã§ä¿®å¾©ã™ã‚‹", candy: -35, survival: 55, msg: "è¡—ã¯å…ƒé€šã‚Šã«ãªã£ãŸã€‚" }] },
        { text: "ã€æ”¯é…ã€‘ãƒ«ãƒ¼ãƒ©ãŒã€Œè·ªã‘ã€ã¨å‘½ã˜ã¦ã„ã‚‹ã€‚", choices: [{ text: "å¾“ã†ãƒ•ãƒªã‚’ã™ã‚‹", candy: -25, survival: 45, msg: "è‡£ä¸‹ã¨ã—ã¦å®ˆã‚‰ã‚ŒãŸã€‚" }, { text: "å‘½ä»¤ã‚’é­”æ³•ã§è·³ã­è¿”ã™", candy: 30, survival: -50, msg: "ä¸»å°æ¨©ã‚’å¥ªã„è¿”ã—ãŸã€‚" }, { text: "èƒŒå¾Œã‹ã‚‰å¥‡è¥²ã™ã‚‹", candy: 45, survival: -90, msg: "ç‹ä½ã‚’ç°’å¥ªã—ã€é£´ã‚’å¥ªã£ãŸã€‚" }] },
        { text: "ã€è¿·å¤¢ã€‘ã­ã‚€ã‚Šã‚“ã®å¤¢ã®ä¸­ã«å…¥ã‚Šè¾¼ã‚“ã§ã—ã¾ã£ãŸã€‚", choices: [{ text: "æ¥½ã—ã„å¤¢ã‚’è¦‹ã›ã‚‹", candy: 15, survival: 25, msg: "ç¾å®Ÿã®å½¼å¥³ã‚‚æº€è¶³ã—ãŸã‚ˆã†ã ã€‚" }, { text: "å¤¢ã‹ã‚‰é£´ã‚’å…·ç¾åŒ–ã™ã‚‹", candy: 30, survival: -20, msg: "ä¸æ€è­°ãªåŠ›ã§é£´ãŒå¢—ãˆãŸã€‚" }, { text: "å¯è¨€ã‚’èã„ã¦ã‚ã’ã‚‹", candy: 0, survival: 35, msg: "å®‰ã‚‰ã‹ãªæ™‚é–“ã‚’éã”ã—ãŸã€‚" }] },
        { text: "ã€æ…ˆæ„›ã€‘ã‚·ã‚¹ã‚¿ãƒ¼ãƒŠãƒŠãŒæ„›ã‚’èª¬ã„ã¦ã„ã‚‹ã€‚", choices: [{ text: "å…±ã«å¹³å’Œã‚’ç¥ˆã‚‹", candy: 5, survival: 45, msg: "ç²¾ç¥çš„ãªå®ˆè­·ã‚’å¾—ãŸã€‚" }, { text: "æ´»å‹•è³‡é‡‘ã¨ã—ã¦é£´ã‚’å¯„ä»˜ã™ã‚‹", candy: -40, survival: 80, msg: "çµ¶å¤§ãªä¿¡é ¼ã‚’å¾—ãŸã€‚" }, { text: "å½å–„ã ã¨ç¬‘ã†", candy: 5, survival: -25, msg: "æ°—ã¾ãšã„æ²ˆé»™ã€‚" }] }
    ];

    window.onload = () => {
        const charGrid = document.getElementById('char-selection');
        state.characterList.forEach((c, idx) => {
            const btn = document.createElement('button');
            btn.className = 'setup-btn';
            btn.innerText = c.name;
            btn.onclick = () => selectChar(idx, btn);
            charGrid.appendChild(btn);
        });
        const rand = Math.floor(Math.random()*state.characterList.length);
        selectChar(rand, charGrid.children[rand]);
    };

    function selectChar(idx, btn) {
        document.querySelectorAll('#char-selection .setup-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.playerName = state.characterList[idx].name;
        state.magicName = state.characterList[idx].magic;
    }

    function setDifficulty(diff, btn) {
        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.difficulty = diff;
        document.getElementById('mode-display').innerText = diff.toUpperCase();
    }

    function toggleSpeed() {
        state.gameSpeed = document.getElementById('speed-toggle').checked ? 2 : 1;
    }

    function startGame() {
        if (document.getElementById('bgm-toggle').checked) {
            bgm.play().catch(e => console.log("å†ç”Ÿåˆ¶é™å›é¿"));
        }
        document.getElementById('setup-screen').style.display = 'none';
        npcList = state.characterList.filter(n => n.name !== state.playerName).map(n => n.name);
        npcList.forEach(name => state.npcScores[name] = 40 + Math.floor(Math.random()*20));
        triggerFav(`${state.playerName}ã€å›ã®é­”æ³•ã¯${state.magicName}ã ã½ã‚“ã€‚<br>é‡‘æ›œã®å¤œã«ã€Œæœ€ä¸‹ä½ã€ã ã¨æ¶ˆã•ã‚Œã‚‹ã½ã‚“ã€‚é ‘å¼µã‚‹ã½ã‚“ï¼`, startTurn);
        updateUI();
        updateRanking();
    }

    function updateUI() {
        document.getElementById('candy-display').innerText = state.candies;
        document.getElementById('survivor-display').innerText = state.survivors;
        document.getElementById('week-display').innerText = state.week;
        document.getElementById('day-display').innerText = days[state.dayIndex];
    }

    function updateRanking() {
        const list = document.getElementById('ranking-list');
        list.innerHTML = '';
        let fullList = [];
        npcList.forEach(name => {
            fullList.push({ name: name, candies: state.npcScores[name], isPlayer: false });
        });
        fullList.push({ name: state.playerName, candies: state.candies, isPlayer: true });
        fullList.sort((a,b) => b.candies - a.candies);
        fullList.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = `ranking-item ${item.isPlayer ? 'player' : ''}`;
            div.innerHTML = `<span>${i+1}. ${item.name}</span><span>${item.candies}ğŸ¬</span>`;
            list.appendChild(div);
        });
    }

    function typeWriter(text, elementId, callback) {
        const el = document.getElementById(elementId);
        el.innerHTML = "";
        let i = 0;
        const speed = 30 / state.gameSpeed;
        function type() {
            if (i < text.length) {
                el.innerHTML += text.charAt(i);
                i++;
                setTimeout(type, speed);
            } else if (callback) { callback(); }
        }
        type();
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function startTurn() {
        if (state.isGameOver) return;
        if (state.dayIndex >= days.length) { processFriday(); return; }
        updateUI();
        updateRanking();
        npcList.forEach(name => {
            const gain = Math.floor(Math.random()*15) * state.difficultyMults[state.difficulty];
            state.npcScores[name] += Math.round(gain);
        });
        const pool = commonEvents.concat(mgEvents);
        const ev = pool[Math.floor(Math.random() * pool.length)];
        document.getElementById('choices-container').innerHTML = '';
        typeWriter(ev.text, 'message-window', () => {
            const shuffledChoices = shuffleArray([...ev.choices]);
            shuffledChoices.forEach((c) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = c.text;
                btn.onclick = () => handleChoice(c);
                document.getElementById('choices-container').appendChild(btn);
            });
        });
    }

    function handleChoice(choice) {
        document.getElementById('choices-container').innerHTML = '';
        const luck = Math.random();
        let mult = 1.0; let prefix = "";
        if (luck > 0.85) { mult = 1.5; prefix = "ã€ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼ã€‘ "; }
        else if (luck < 0.15) { mult = 0.5; prefix = "ã€ä¸é‹â€¦â€¦ã€‘ "; }
        const cGained = Math.round(choice.candy * mult);
        state.candies += cGained;
        state.dayIndex++;
        if (cGained < 0) flashRed();
        const resultMsg = `${prefix}${choice.msg} <br>ï¼ˆé£´: ${cGained >= 0 ? '+' : ''}${cGained}ï¼‰`;
        typeWriter(resultMsg, 'message-window', () => {
            setTimeout(startTurn, 1500 / state.gameSpeed);
        });
    }

    function processFriday() {
        document.getElementById('game-main').classList.add('glitch-anim');
        setTimeout(() => {
            document.getElementById('game-main').classList.remove('glitch-anim');
            let finalScores = npcList.map(name => ({ name, candies: state.npcScores[name], isPlayer: false }));
            finalScores.push({ name: state.playerName, candies: state.candies, isPlayer: true });
            finalScores.sort((a,b) => a.candies - b.candies);

            if (finalScores.length <= 2) {
                const survivorsList = finalScores.map(f => f.name).join('ã€');
                triggerFav(`ç¬¬${state.week}é€±ã®é›†è¨ˆãŒçµ‚ã‚ã£ãŸã½ã‚“ã€‚æ®‹ã‚Šã¯${finalScores.length}åï¼ˆ${survivorsList}ï¼‰ã ã½ã‚“ã€‚ã‚²ãƒ¼ãƒ ã¯çµ‚äº†ã ã½ã‚“ï¼`, () => {
                    endGameFinal(finalScores);
                });
                return;
            }

            const victim = finalScores[0];
            if (victim.isPlayer) {
                gameOver();
                return;
            } else {
                npcList = npcList.filter(n => n !== victim.name);
                delete state.npcScores[victim.name];
                state.survivors--;
                updateRanking();
                const murderRoll = Math.random();
                if (murderRoll < 0.10 && (npcList.length + 1) >= 2) {
                    const remaining = npcList.slice();
                    remaining.push(state.playerName);
                    const killerIdx = Math.floor(Math.random() * remaining.length);
                    const killer = remaining[killerIdx];
                    let murderBaseMsg = `ç¬¬${state.week}é€±ã®é›†è¨ˆãŒçµ‚ã‚ã£ãŸã½ã‚“ã€‚æœ€ä¸‹ä½ã¯ã€${victim.name}ã€‘ã ã½ã‚“ã€‚æ¶ˆå»ã—ãŸã½ã‚“ã€‚<br>`;

                    if (killer === state.playerName) {
                        typeWriter(murderBaseMsg + "â€¦â€¦ãƒ‰ã‚¹é»’ã„è¡å‹•ãŒæ¹§ãä¸ŠãŒã£ãŸã½ã‚“ã€‚èª°ã‚’ã€Œå‡¦ç†ã€ã™ã‚‹ã½ã‚“ï¼Ÿ", 'message-window', () => {
                            document.getElementById('choices-container').innerHTML = '';
                            npcList.forEach(targetName => {
                                const btn = document.createElement('button');
                                btn.className = 'choice-btn';
                                btn.innerText = `ã€æ®ºå®³ã€‘${targetName}`;
                                btn.onclick = () => executeMurder(killer, targetName, murderBaseMsg);
                                document.getElementById('choices-container').appendChild(btn);
                            });
                        });
                    } else {
                        const targets = remaining.filter(n => n !== killer);
                        const target = targets[Math.floor(Math.random() * targets.length)];
                        executeMurder(killer, target, murderBaseMsg);
                    }
                } else {
                    state.week++;
                    state.dayIndex = 0;
                    triggerFav(`ç¬¬${state.week-1}é€±ã®é›†è¨ˆãŒçµ‚ã‚ã£ãŸã½ã‚“ã€‚æœ€ä¸‹ä½ã¯ã€${victim.name}ã€‘ã ã½ã‚“ã€‚æ¶ˆå»ã—ãŸã½ã‚“ã€‚<br>æ¥é€±ã‚‚é£´ã‚’é›†ã‚ã‚‹ã½ã‚“ï¼`, startTurn);
                }
            }
        }, 2000 / state.gameSpeed);
    }

    function executeMurder(killer, target, baseMsg) {
        document.getElementById('choices-container').innerHTML = '';
        let murderMsg = baseMsg + `ãã®å¾Œã€ã€${killer}ã€‘ãŒã€${target}ã€‘ã‚’æ®ºã—ãŸã½ã‚“ï¼`;
        if (target === state.playerName) {
            triggerFav(murderMsg, () => { gameOver(); });
        } else {
            npcList = npcList.filter(n => n !== target);
            delete state.npcScores[target];
            state.survivors--;
            updateRanking();
            let survivorsNow = npcList.length + 1;
            if (survivorsNow <= 2) {
                const survivorsList = npcList.concat(state.playerName).join('ã€');
                triggerFav(murderMsg + `<br>æ®‹ã‚Šã¯${survivorsNow}åã€‚çµ‚äº†ã ã½ã‚“ã€‚`, () => {
                    endGameFinal(
                        (npcList.map(n => ({ name: n, isPlayer: false, candies: state.npcScores[n] })))
                        .concat([{ name: state.playerName, isPlayer: true, candies: state.candies }])
                    );
                });
            } else {
                state.week++;
                state.dayIndex = 0;
                triggerFav(murderMsg, startTurn);
            }
        }
    }

    function endGameFinal(finalList) {
        state.isGameOver = true;
        const survivorsNames = finalList.map(f => f.name).join('ã€');
        document.getElementById('game-main').innerHTML = `
            <div style="text-align:center; margin-top:120px">
                <h1 style="font-size:2.5rem">GAME END</h1>
                <p>æ®‹ã‚Šã®é­”æ³•å°‘å¥³: ${survivorsNames}</p>
                <p>å¥‘ç´„çµ‚äº†ã ã½ã‚“ï¼</p>
                <button class="restart-btn" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            </div>
        `;
    }

    function triggerFav(msg, cb) {
        document.getElementById('fav-message').innerHTML = msg;
        document.getElementById('fav-popup').style.display = 'block';
        window.favCb = cb;
    }
    
    function closeFav() {
        document.getElementById('fav-popup').style.display = 'none';
        if(window.favCb) { window.favCb(); window.favCb = null; }
    }

    function flashRed() {
        const m = document.getElementById('game-main');
        m.classList.remove('flash-red-anim');
        void m.offsetWidth;
        m.classList.add('flash-red-anim');
    }

    function gameOver() {
        state.isGameOver = true;
        document.getElementById('game-main').innerHTML = `
            <div style="text-align:center; margin-top:150px">
                <h1 class="glitch-anim" style="font-size:3rem">SYSTEM PURGE</h1>
                <p>æ¶ˆå»ã•ã‚Œã¾ã—ãŸã€‚</p>
                <button class="restart-btn" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹</button>
            </div>
        `;
    }
</script>
</body>
</html>
