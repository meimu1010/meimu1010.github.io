<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magical Girl Survival Simulator - EX Complete</title>
    <style>
        :root {
            --pastel-pink: #ffd1dc;
            --deep-pink: #ff1493;
            --black: #0d0609;
            --blood-red: #8a0303;
        }
        body {
            background-color: var(--black);
            color: var(--pastel-pink);
            font-family: 'MS Mincho', 'Hiragino Mincho ProN', serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        #game-container {
            width: 1000px;
            height: 600px;
            background: linear-gradient(180deg, #1a0b12 0%, #000000 100%);
            border: 2px solid var(--deep-pink);
            box-shadow: 0 0 30px rgba(255, 20, 147, 0.3);
            position: relative;
            display: flex;
            overflow: hidden;
        }

        .scanlines {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 255, 0, 0.06));
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
            z-index: 100;
        }

        #game-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            border-right: 1px solid var(--deep-pink);
        }

        #status-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: rgba(255, 20, 147, 0.15);
            border-bottom: 1px solid var(--deep-pink);
            font-size: 1.1rem;
            z-index: 10;
        }

        #ranking-panel {
            width: 250px;
            background: rgba(13, 6, 9, 0.8);
            padding: 15px;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }

        .ranking-title { text-align: center; border-bottom: 1px solid var(--pastel-pink); margin-bottom: 10px; color: var(--deep-pink); font-weight: bold; }
        .ranking-item { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85rem;}
        .ranking-item.player { color: #fff; text-shadow: 0 0 5px var(--deep-pink); font-weight: bold; }

        #main-view { flex-grow: 1; display: flex; flex-direction: column; justify-content: flex-end; padding: 20px; }
        #message-window {
            background: rgba(255, 209, 220, 0.1);
            border: 1px solid var(--deep-pink);
            padding: 20px;
            min-height: 100px;
            font-size: 1.2rem;
            margin-bottom: 15px;
            z-index: 10;
        }

        #choices-container { display: flex; flex-direction: column; gap: 8px; z-index: 10; }
        .choice-btn {
            background: rgba(0, 0, 0, 0.7);
            color: var(--pastel-pink);
            border: 1px solid var(--pastel-pink);
            padding: 12px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }
        .choice-btn:hover { background: var(--deep-pink); color: #fff; }

        #setup-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--black);
            z-index: 200;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            box-sizing: border-box;
        }
        .setup-group { margin-bottom: 20px; text-align: center; width: 100%; }
        .char-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 10px; max-height: 200px; overflow-y: auto; padding: 10px; border: 1px solid #333; }
        .setup-btn { background: #000; border: 1px solid var(--pastel-pink); color: var(--pastel-pink); padding: 5px; cursor: pointer; font-size: 0.8rem; }
        .setup-btn.active { background: var(--deep-pink); color: white; border-color: white; }
        .start-btn { padding: 15px 40px; font-size: 1.5rem; background: var(--deep-pink); color: white; border: none; cursor: pointer; margin-top: 20px; }

        #speed-ctrl {
            padding: 5px 20px;
            background: rgba(0,0,0,0.5);
            font-size: 0.8rem;
            display: flex;
            gap: 10px;
            align-items: center;
            border-top: 1px solid #333;
        }

        #fav-popup {
            position: absolute;
            top: 50%; left: 40%;
            transform: translate(-50%, -50%);
            width: 50%;
            background: rgba(0, 0, 0, 0.95);
            border: 3px dashed var(--pastel-pink);
            padding: 20px;
            text-align: center;
            display: none;
            z-index: 150;
        }

        @keyframes flashRed {
            0% { box-shadow: inset 0 0 0px var(--blood-red); }
            50% { box-shadow: inset 0 0 100px var(--blood-red); background-color: rgba(138, 3, 3, 0.4); }
            100% { box-shadow: inset 0 0 0px var(--blood-red); }
        }
        .flash-red-anim { animation: flashRed 0.3s 3; }
        .glitch-anim { animation: glitch 0.2s linear infinite; color: red; }
        @keyframes glitch { 0%, 100% { transform: translate(0); } 20% { transform: translate(-2px, 2px); } 40% { transform: translate(2px, -2px); } }

        .restart-btn {
            background: transparent; color: white; border: 1px solid white; padding: 10px 20px; cursor: pointer; font-family: inherit; margin-top: 20px;
        }
        .restart-btn:hover { background: white; color: black; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="scanlines"></div>

    <div id="setup-screen">
        <h1 style="color:var(--deep-pink)">Magical Girl Survival</h1>
        <div class="setup-group">
            <p>難易度（ライバルの強さ）を選択してぽん：</p>
            <button class="setup-btn difficulty-btn" onclick="setDifficulty('easy', this)">イージー（激甘）</button>
            <button class="setup-btn difficulty-btn active" onclick="setDifficulty('normal', this)">ノーマル</button>
            <button class="setup-btn difficulty-btn" onclick="setDifficulty('hard', this)">ハード（絶望）</button>
        </div>
        <div class="setup-group">
            <p>操作する魔法少女を選んでぽん：</p>
            <div id="char-selection" class="char-grid"></div>
        </div>
        <button class="start-btn" onclick="startGame()">契約するぽん！</button>
    </div>
    
    <div id="game-main">
        <div id="status-bar">
            <div>🍬: <span id="candy-display">50</span></div>
            <div>🧚: <span id="survivor-display">16</span>/16</div>
            <div>⏱ 第<span id="week-display">1</span>週 <span id="day-display">月</span></div>
        </div>
        <div id="main-view">
            <div id="message-window">...</div>
            <div id="choices-container"></div>
        </div>
        <div id="speed-ctrl">
            モード: <span id="mode-display">NORMAL</span> | 
            <label><input type="checkbox" id="speed-toggle" onchange="toggleSpeed()"> 2倍速モード</label>
        </div>
    </div>
    <div id="ranking-panel">
        <div class="ranking-title">キャンディー所持数</div>
        <div id="ranking-list"></div>
    </div>
    <div id="fav-popup">
        <div style="font-size:2rem">🧚</div>
        <div id="fav-message"></div>
        <button onclick="closeFav()" style="margin-top:10px">分かったぽん</button>
    </div>
</div>

<script>
    let state = {
        candies: 50,
        week: 1,
        dayIndex: 0,
        survivors: 16,
        playerName: "",
        magicName: "",
        isGameOver: false,
        gameSpeed: 1,
        difficulty: 'normal',
        difficultyMults: { easy: 0.6, normal: 1.0, hard: 1.5 }, // NPCへの補正
        characterList: [
            { name: "ハードゴア・アリス", magic: "『どんな怪我をしてもすぐに治るよ』" },
            { name: "スノーホワイト", magic: "『困っている人の心の声が聞こえるよ』" },
            { name: "リップル", magic: "『投げたものが必ず的に当たるよ』" },
            { name: "ラ・ピュセル", magic: "『剣の大きさを自由に変えられるよ』" },
            { name: "トップスピード", magic: "『猛スピードで空を飛ぶ魔法の箒を使うよ』" },
            { name: "カラミティ・メアリ", magic: "『持っている武器をパワーアップさせるよ』" },
            { name: "マジカルロイド44", magic: "『未来の便利な道具を毎日一つ出せるよ』" },
            { name: "ユナエル", magic: "『好きな生き物に変身できるよ』" },
            { name: "ミナエル", magic: "『好きな物（無機物）に変身できるよ』" },
            { name: "たま", magic: "『色んなものに素早く穴を開けられるよ』" },
            { name: "ねむりん", magic: "『他人の夢の中に入ることができるよ』" },
            { name: "ルーラ", magic: "『目の前の相手にどんな命令でも聞かせられるよ』" },
            { name: "スイムスイム", magic: "『どんなものにでも水みたいに潜り込めるよ』" },
            { name: "森の音楽家クラムベリー", magic: "『音を自由自在に操ることができるよ』" },
            { name: "シスター・ナナ", magic: "『好きな人の能力を飛躍的に高めるよ』" },
            { name: "ヴェス・ウィンタープリズン", magic: "『何もないところに壁を作り出せるよ』" }
        ],
        npcScores: {}
    };

    let npcList = [];
    const days = ["月", "火", "水", "木", "金"];

    const commonEvents = [
        { text: "ひったくりが逃走している！", choices: [{ text: "魔法で捕まえる", candy: 15, survival: -25, msg: "犯人を捕まえたが目立ってしまった。" }, { text: "足を引っかける", candy: 8, survival: 0, msg: "うまく転ばせた。" }, { text: "協力者にキャンディーを渡して任せる", candy: -25, survival: 30, msg: "安全に解決したが多くの飴を失った。" }] },
        { text: "大規模なビル火災が発生。生存者がいる。", choices: [{ text: "直接救出に向かう", candy: 30, survival: -45, msg: "英雄として称えられたが消耗が激しい。" }, { text: "魔法で消火を助ける", candy: 20, survival: -15, msg: "効率的に鎮火した。" }, { text: "周囲の安全を確保する", candy: 5, survival: 10, msg: "二次被害を防いだ。" }] },
        { text: "老人が重い荷物を運んでいる。", choices: [{ text: "目的地まで運ぶ", candy: 8, survival: 5, msg: "小さな徳を積んだ。" }, { text: "魔法で軽量化する", candy: 10, survival: -10, msg: "老人は驚いたが無事に着いた。" }, { text: "高級な台車を魔法で召喚して贈る", candy: -25, survival: 40, msg: "非常に感謝され、生存の噂が広まった。" }] },
        { text: "魔法少女を狩る者が近くにいるらしい。", choices: [{ text: "罠を仕掛ける", candy: 25, survival: -45, msg: "返り討ちにしたが負傷した。" }, { text: "拠点を魔法で補強する", candy: -35, survival: 50, msg: "安全を確保した。" }, { text: "人混みに紛れて過ごす", candy: 0, survival: 10, msg: "やり過ごした。" }] },
        { text: "公園で「飴をくれたらいい情報を教える」と言う不審者がいる。", choices: [{ text: "飴を35個渡す", candy: -35, survival: 60, msg: "有用な生存情報を得た。" }, { text: "力ずくで聞き出す", candy: 12, survival: -40, msg: "情報を奪ったが警戒されている。" }, { text: "相手にしない", candy: 0, survival: 5, msg: "賢明な判断だ。" }] },
        { text: "深夜の病院で、不自然な魔力の揺らぎを感知した。", choices: [{ text: "霊を魔法で浄化する", candy: 20, survival: -30, msg: "感謝の念が飴に変わった。" }, { text: "魔力を隠して調査する", candy: 5, survival: 10, msg: "事件の証拠を掴んだ。" }, { text: "結界を張って放置する", candy: -25, survival: 40, msg: "飴を消費して安全を確保した。" }] },
        { text: "自分の「魔法少女としての姿」がSNSで拡散されそうだ。", choices: [{ text: "魔法でサーバーを焼く", candy: 15, survival: -40, msg: "証拠隠滅には成功したが、管理者に目をつけられた。" }, { text: "飴をばら撒いてデマだと信じ込ませる", candy: -55, survival: 80, msg: "大量の飴を失ったが、完璧に隠蔽した。" }, { text: "何もしない", candy: 0, survival: -25, msg: "正体がバレ、生存率が大きく下がった。" }] },
        { text: "地下水道に異形の怪物が住み着いている。", choices: [{ text: "全力で討伐する", candy: 40, survival: -55, msg: "死闘の末、飴を回収。" }, { text: "怪物の餌として飴を置く", candy: -40, survival: 60, msg: "怪物は満足して去り、安全を得た。" }, { text: "入り口を封鎖する", candy: 5, survival: 15, msg: "被害を最小限に抑えた。" }] },
        { text: "「魔法少女ファン」を名乗る子供が、サインを求めてきた。", choices: [{ text: "派手な魔法を見せて喜ばせる", candy: 15, survival: -25, msg: "笑顔と飴をもらったが、居場所がバレた。" }, { text: "魔法のチャームをプレゼントする", candy: -25, survival: 45, msg: "子供の幸福感が、間接的にあなたを守った。" }, { text: "冷たくあしらう", candy: 0, survival: 5, msg: "リスクは避けた。" }] },
        { text: "猛吹雪が街を襲い、多くの人が遭難している。", choices: [{ text: "街全体を暖める魔法を使う", candy: 45, survival: -80, msg: "奇跡の救助。しかし、魔力が枯渇寸前だ。" }, { text: "避難所に飴を燃料として提供する", candy: -50, survival: 60, msg: "飴の魔力で人々が救われ、信頼を得た。" }, { text: "自分だけ暖を取る", candy: 0, survival: 20, msg: "自分一人生き残る分には十分だ。" }] },
        { text: "古い鏡の中から、自分と同じ姿の影が襲いかかってきた。", choices: [{ text: "影を力でねじ伏せる", candy: 20, survival: -50, msg: "激しい消耗を伴ったが、自分に打ち勝った。" }, { text: "影に飴を分け与える", candy: -35, survival: 60, msg: "影はあなたの優しさに満足して消えた。" }, { text: "鏡を叩き割る", candy: 5, survival: -20, msg: "不吉な予感が残った。" }] },
        { text: "ファヴが「臨時ボーナスのチャンスだぽん」と囁いている。", choices: [{ text: "危険な賭けに乗る", candy: 60, survival: -100, msg: "成功したが命を削りすぎた。" }, { text: "飴をワイロとして渡し、情報を引き出す", candy: -50, survival: 70, msg: "ファヴは機嫌を良くし、重要情報をくれた。" }, { text: "無視して働く", candy: 10, survival: 0, msg: "堅実が一番だ。" }] },
        { text: "工事現場でクレーンが倒壊し、通行人が下敷きになりそうだ。", choices: [{ text: "クレーンを魔法で支える", candy: 35, survival: -50, msg: "超人的な活躍で飴を稼いだ。" }, { text: "通行人をワープさせる", candy: 15, survival: -30, msg: "一瞬で救助。目撃者は少ない。" }, { text: "現場に飴のバリアを張る", candy: -35, survival: 55, msg: "飴のクッションで死者は免れた。" }] },
        { text: "街のシンボルタワーに、魔法の時限爆弾が仕掛けられた。", choices: [{ text: "魔法で解除を試みる", candy: 40, survival: -60, msg: "大爆発は防いだが、腕に怪物のような傷を負った。" }, { text: "爆発の影響を飴で相殺する", candy: -60, survival: 80, msg: "損害は出たが、人的被害はゼロだ。" }, { text: "犯人を追う", candy: 25, survival: -40, msg: "爆発は防げなかったが、犯人から飴を奪った。" }] },
        { text: "記憶を失った魔法少女が、あなたを親だと思い込んでいる。", choices: [{ text: "飴を与えて面倒を見る", candy: -50, survival: 90, msg: "強力な守護者として彼女があなたを守る。" }, { text: "魔法で記憶を捏造して去らせる", candy: 10, survival: -30, msg: "後味は悪いが、飴は回収した。" }, { text: "放置する", candy: 0, survival: -20, msg: "彼女は消えてしまった。" }] },
        { text: "ある宗教団体が「魔法少女は悪魔だ」とデモを行っている。", choices: [{ text: "魔法で教祖を操る", candy: 20, survival: -50, msg: "活動を止めさせたが、強い呪いを受けた。" }, { text: "飴を供物として渡し、和解する", candy: -35, survival: 55, msg: "彼らはあなたを天使だと崇め始めた。" }, { text: "別の街へ拠点を移す", candy: -30, survival: 40, msg: "安全な場所を飴で買った。" }] },
        { text: "深い森の奥で、願いを叶える泉を見つけた。", choices: [{ text: "「飴が欲しい」と願う", candy: 50, survival: -80, msg: "不浄な飴が手に入った。体調が悪い。" }, { text: "「命が欲しい」と願い、飴を捧げる", candy: -60, survival: 120, msg: "生存への強い活力を得た。" }, { text: "泉に触れずに去る", candy: 0, survival: 10, msg: "賢明な判断だ。" }] },
        { text: "カジノのオーナーが魔法少女をボディーガードに雇いたがっている。", choices: [{ text: "高額報酬で引き受ける", candy: 80, survival: -110, msg: "大金（飴）を得たが、命を狙われる。" }, { text: "断る代わりに守りの飴を売る", candy: 15, survival: 0, msg: "小さな商談成立。" }, { text: "カジノを魔法で破産させる", candy: 40, survival: -60, msg: "不正を暴き、飴を奪い取った。" }] },
        { text: "深夜の学校で「百物語」をしていた生徒が消えた。", choices: [{ text: "異界に突入して救出する", candy: 30, survival: -55, msg: "恐怖の体験だったが、報酬は得た。" }, { text: "異界の入り口を飴で封印する", candy: -35, survival: 60, msg: "生徒は戻れないが、これ以上の被害はない。" }, { text: "朝日が昇るのを待つ", candy: 5, survival: 10, msg: "あなたは安全だ。" }] },
        { text: "魔法少女専用の「闇市」が開かれている。", choices: [{ text: "商品を奪って逃げる", candy: 50, survival: -85, msg: "指名手配されたが、戦利品は多い。" }, { text: "安全を買う（飴70消費）", candy: -70, survival: 150, msg: "最高級の安全を手に入れた。" }, { text: "冷やかしで見て回る", candy: 0, survival: 5, msg: "情報は少し入った。" }] },
        { text: "大規模な停電が発生し、街がパニックに陥っている。", choices: [{ text: "魔法で発電する", candy: 25, survival: -40, msg: "多大な魔力を消費して飴を得た。" }, { text: "パニックを飴の力で鎮める", candy: -35, survival: 65, msg: "人々は安らぎ、暴動は収まった。" }, { text: "暗闇に乗じて他者の飴を奪う", candy: 40, survival: -70, msg: "悪い魔法少女だ。" }] },
        { text: "謎の病が魔法少女の間で流行している。", choices: [{ text: "特効薬を魔法で生成する", candy: 30, survival: -65, msg: "自分の命を削って薬を作った。" }, { text: "飴を消費してワクチンを買う", candy: -50, survival: 100, msg: "感染を免れ、体調も万全だ。" }, { text: "感染者から距離を置く", candy: 0, survival: 10, msg: "自分だけは無傷だ。" }] },
        { text: "空から巨大な隕石が降ってきている！", choices: [{ text: "魔法の最大出力で粉砕する", candy: 80, survival: -180, msg: "世界を救ったが、あなたは死の淵に。" }, { text: "落下地点に飴のクッションを作る", candy: -100, survival: 120, msg: "甚大な飴を失ったが、奇跡的に助かった。" }, { text: "地下シェルターに逃げ込む", candy: -20, survival: 30, msg: "文明は崩壊したが、あなたは生きている。" }] },
        { text: "誰かがあなたに「呪いの飴」を送りつけてきた。", choices: [{ text: "呪いを解除して食べる", candy: 25, survival: -50, msg: "不快な味がしたが、力にはなった。" }, { text: "呪いを他人に転嫁する", candy: 5, survival: -30, msg: "最悪の気分だ。" }, { text: "飴を浄化して捨てる", candy: -25, survival: 45, msg: "安全第一。" }] },
        { text: "テレビの生放送中に怪獣が現れた。", choices: [{ text: "カメラの前で戦う", candy: 60, survival: -120, msg: "一躍スターだが、全魔法少女のターゲットに。" }, { text: "魔法で放送をジャックし、隠れて戦う", candy: 20, survival: -40, msg: "堅実に処理した。" }, { text: "中継車を魔法で守る", candy: -20, survival: 30, msg: "マスコミに恩を売った。" }] },
        { text: "捨てられたアンドロイドが魔法の核で動いている。", choices: [{ text: "核を抜き取る", candy: 40, survival: -40, msg: "冷酷な判断。飴を得た。" }, { text: "飴を与えて再起動させる", candy: -45, survival: 80, msg: "忠実なロボットがあなたを守る。" }, { text: "そのまま破壊する", candy: 5, survival: 10, msg: "危険の芽を摘んだ。" }] },
        { text: "古い書物に「魔法少女を辞める方法」が書いてあった。", choices: [{ text: "詳しく読む", candy: -35, survival: 95, msg: "希望が見え、生存意欲が高まった。" }, { text: "嘘だと断じて燃やす", candy: 15, survival: -20, msg: "今の力に執着した。" }, { text: "仲間に飴で情報を売る", candy: 30, survival: -30, msg: "罪深い取引だ。" }] },
        { text: "魔法の木が枯れかけている。", choices: [{ text: "自分の魔力を注ぐ", candy: 25, survival: -50, msg: "木は蘇り、少量の飴の実をつけた。" }, { text: "飴を肥料として埋める", candy: -45, survival: 85, msg: "精霊の加護を得た。" }, { text: "木を薪にして暖を取る", candy: 5, survival: -15, msg: "バチが当たりそうだ。" }] },
        { text: "迷い込んだ並行世界から、もう一人の自分が助けを求めている。", choices: [{ text: "彼女を救って招き入れる", candy: -70, survival: 130, msg: "二人のあなたが互いを守り合う。" }, { text: "彼女を見捨てて飴だけ奪う", candy: 50, survival: -60, msg: "並行世界の自分を殺した罪悪感。" }, { text: "扉を閉じる", candy: 0, survival: 10, msg: "異変を拒絶した。" }] },
        { text: "街を巨大な霧が包み、人々の正気を奪っている。", choices: [{ text: "霧の核を破壊する", candy: 30, survival: -60, msg: "幻覚と戦い、勝利した。" }, { text: "飴を媒介に浄化の風を起こす", candy: -55, survival: 80, msg: "清浄な空気が戻った。" }, { text: "霧の中で他人の所持品を漁る", candy: 25, survival: -30, msg: "卑しい行為だ。" }] },
        { text: "伝説の武具がオークションに出品されている。", choices: [{ text: "力ずくで強奪する", candy: 55, survival: -110, msg: "警備をなぎ倒した。" }, { text: "全財産の飴を投じて落札する", candy: -150, survival: 300, msg: "無一文だが、最強の守りを得た。" }, { text: "見送る", candy: 5, survival: 5, msg: "平和が一番だ。" }] },
        { text: "ファヴの隠し口座を見つけた。", choices: [{ text: "飴を不正送金する", candy: 120, survival: -180, msg: "莫大な飴を得たが、抹殺対象になった。" }, { text: "弱みとして握り、脅す", candy: 15, survival: 40, msg: "ファヴが少し優しくなった。" }, { text: "何も見なかったことにする", candy: 10, survival: 20, msg: "賢明だ。" }] },
        { text: "魔法少女を愛でる「魔法少女喫茶」が流行っている。", choices: [{ text: "バイトとして働く", candy: 30, survival: -45, msg: "精神的に削られるが、飴は良い。" }, { text: "偽物だと抗議して飴を要求する", candy: 15, survival: -20, msg: "迷惑料をぶんどった。" }, { text: "店を魔法で改造してあげる", candy: -25, survival: 50, msg: "隠れた支援者として愛された。" }] },
        { text: "自分の魔法が、他人の不運を吸い取って成長し始めた。", choices: [{ text: "そのまま成長させる", candy: 50, survival: -100, msg: "呪われた力。命を削る。" }, { text: "飴を消費してこの力を封印する", candy: -60, survival: 90, msg: "正しい心を取り戻した。" }, { text: "特定のターゲットに不運をぶつける", candy: 25, survival: -50, msg: "ライバルを追い詰めた。" }] },
        { text: "街に「願いの流星群」が降る夜だ。", choices: [{ text: "全ての星を飴に変える", candy: 100, survival: -130, msg: "空前の飴獲得量。しかし運命が歪んだ。" }, { text: "星に平和を祈る", candy: 0, survival: 50, msg: "穏やかな奇跡が起きた。" }, { text: "願いを飴で買い取り、叶えてあげる", candy: -55, survival: 100, msg: "人々の希望があなたを支える。" }] },
        { text: "魔法少女の遺品整理を依頼された。", choices: [{ text: "形見を自分のものにする", candy: 30, survival: -40, msg: "呪われた遺品だが力にはなる。" }, { text: "遺族へ飴と一緒に届ける", candy: -35, survival: 65, msg: "涙ながらに感謝された。" }, { text: "全て焼却処分する", candy: 5, survival: 10, msg: "未練を断ち切った。" }] },
        { text: "巨大な魔法少女の銅像が動き出した。", choices: [{ text: "倒して素材にする", candy: 40, survival: -65, msg: "激戦。銅像から飴を削り出した。" }, { text: "飴を供えて鎮める", candy: -40, survival: 60, msg: "銅像は再び静寂に戻った。" }, { text: "街を壊すのを眺める", candy: 0, survival: -30, msg: "街がボロボロだ。" }] },
        { text: "魔法少女ランキングの操作疑惑が浮上した。", choices: [{ text: "ハッキングして自分を1位にする", candy: 80, survival: -150, msg: "数字は完璧だが、刺客が絶えない。" }, { text: "証拠を飴で買い取り、公表する", candy: -60, survival: 90, msg: "正義が行われ、あなたは英雄視された。" }, { text: "静観する", candy: 5, survival: 10, msg: "泥沼には関わらない。" }] },
        { text: "ある子供が「魔法少女になりたい」と泣いている。", choices: [{ text: "地獄（ファヴ）に繋ぐ", candy: 40, survival: -80, msg: "紹介料をもらった。あなたは悪魔だ。" }, { text: "飴をあげて、普通の幸せを諭す", candy: -25, survival: 50, msg: "一人の少女を救ったのかもしれない。" }, { text: "魔法でその記憶を消す", candy: 10, survival: -15, msg: "慈悲深い残酷。" }] },
        { text: "突然、魔法少女としての変身が解けなくなった。", choices: [{ text: "そのままの姿で生きる", candy: 20, survival: -70, msg: "一生狙われ続ける恐怖。" }, { text: "飴を消費して解呪する", candy: -65, survival: 110, msg: "人間に戻る安らぎを得た。" }, { text: "ファヴに文句を言う", candy: 5, survival: -15, msg: "あしらわれた。" }] }
    ];

    const mgEvents = [
        { text: "【遭遇】リップルが特訓をしている。", choices: [{ text: "一緒に訓練する", candy: 10, survival: -25, msg: "技術は上がったが疲弊した。" }, { text: "的に魔法を動かす", candy: 18, survival: -30, msg: "彼女は怒ったが飴を得た。" }, { text: "差し入れに飴を渡す", candy: -25, survival: 45, msg: "少し仲良くなれた。" }] },
        { text: "【交流】スノーホワイトが困っている人の声を聞いている。", choices: [{ text: "手伝いを申し出る", candy: 20, survival: -20, msg: "二人で多くの人を救った。" }, { text: "彼女の代わりに飴を集める", candy: 30, survival: -45, msg: "感謝されたが危険が増した。" }, { text: "遠くから静観する", candy: 0, survival: 10, msg: "心が洗われた。" }] },
        { text: "【危機】カラミティ・メアリが酔って暴れている。", choices: [{ text: "正面から止める", candy: 40, survival: -80, msg: "激戦の末、沈静化させた。" }, { text: "酒に睡眠薬を混ぜる", candy: 15, survival: -30, msg: "うまく眠らせた。" }, { text: "飴を置いて去る", candy: -45, survival: 60, msg: "店主から深く感謝された。" }] },
        { text: "【取引】マジカルロイド44が怪しい機械を売っている。", choices: [{ text: "飴増殖機を買う", candy: -50, survival: 15, msg: "即座に爆発した！" }, { text: "シールドを買う", candy: -35, survival: 65, msg: "頑丈な守りを得た。" }, { text: "彼女をスクラップにする", candy: 35, survival: -60, msg: "パーツを飴と交換した。" }] },
        { text: "【強襲】スイムスイムが床から忍び寄ってきた！", choices: [{ text: "全力で空へ逃げる", candy: 0, survival: 20, msg: "危機一髪で回避した。" }, { text: "床を魔法で硬質化させる", candy: 15, survival: -20, msg: "彼女を閉じ込めて追い払った。" }, { text: "持っていた飴をすべて差し出す", candy: -80, survival: 150, msg: "見逃してもらえたが、ほぼ全てを失った。" }] },
        { text: "【誘惑】クラムベリーが演奏会を開いている。", choices: [{ text: "聴き入る", candy: 0, survival: -60, msg: "旋律に当てられ、衰弱した。" }, { text: "拍手と共に飴を贈る", candy: -30, survival: 60, msg: "「強い魂」だと認められた。" }, { text: "演奏を魔法で妨害する", candy: 30, survival: -80, msg: "殺し合いに発展した。" }] },
        { text: "【事故】たまが誤って街を穴だらけにしてしまった。", choices: [{ text: "一緒に埋め戻す", candy: 5, survival: 25, msg: "たまは泣いて喜んだ。" }, { text: "穴を利用して罠を作る", candy: 25, survival: -45, msg: "効率的に他者から奪えた。" }, { text: "魔法で修復する", candy: -35, survival: 55, msg: "街は元通りになった。" }] },
        { text: "【支配】ルーラが「跪け」と命じている。", choices: [{ text: "従うフリをする", candy: -25, survival: 45, msg: "臣下として守られた。" }, { text: "命令を魔法で跳ね返す", candy: 30, survival: -50, msg: "主導権を奪い返した。" }, { text: "背後から奇襲する", candy: 45, survival: -90, msg: "王位を簒奪し、飴を奪った。" }] },
        { text: "【迷夢】ねむりんの夢の中に入り込んでしまった。", choices: [{ text: "楽しい夢を見せる", candy: 15, survival: 25, msg: "現実の彼女も満足したようだ。" }, { text: "夢から飴を具現化する", candy: 30, survival: -20, msg: "不思議な力で飴が増えた。" }, { text: "寝言を聞いてあげる", candy: 0, survival: 35, msg: "安らかな時間を過ごした。" }] },
        { text: "【慈愛】シスターナナが愛を説いている。", choices: [{ text: "共に平和を祈る", candy: 5, survival: 45, msg: "精神的な守護を得た。" }, { text: "活動資金として飴を寄付する", candy: -40, survival: 80, msg: "絶大な信頼を得た。" }, { text: "偽善だと笑う", candy: 5, survival: -25, msg: "気まずい沈黙。" }] }
    ];

    while (commonEvents.length < 40) {
        commonEvents.push({...commonEvents[Math.floor(Math.random()*commonEvents.length)], text: "【再発】" + commonEvents[Math.floor(Math.random()*commonEvents.length)].text});
    }

    window.onload = () => {
        const charGrid = document.getElementById('char-selection');
        state.characterList.forEach((c, idx) => {
            const btn = document.createElement('button');
            btn.className = 'setup-btn';
            btn.innerText = c.name;
            btn.onclick = () => selectChar(idx, btn);
            charGrid.appendChild(btn);
        });
        const rand = Math.floor(Math.random()*state.characterList.length);
        selectChar(rand, charGrid.children[rand]);
    };

    function selectChar(idx, btn) {
        document.querySelectorAll('#char-selection .setup-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.playerName = state.characterList[idx].name;
        state.magicName = state.characterList[idx].magic;
    }

    function setDifficulty(diff, btn) {
        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.difficulty = diff;
        document.getElementById('mode-display').innerText = diff.toUpperCase();
    }

    function toggleSpeed() {
        state.gameSpeed = document.getElementById('speed-toggle').checked ? 2 : 1;
    }

    function startGame() {
        document.getElementById('setup-screen').style.display = 'none';
        npcList = state.characterList.filter(n => n.name !== state.playerName).map(n => n.name);
        npcList.forEach(name => state.npcScores[name] = 40 + Math.floor(Math.random()*20));
        
        triggerFav(`${state.playerName}、君の魔法は${state.magicName}だぽん。<br>金曜の夜に「最下位」だと消されるぽん。頑張るぽん！`, startTurn);
        updateUI();
        updateRanking();
    }

    function updateUI() {
        document.getElementById('candy-display').innerText = state.candies;
        document.getElementById('survivor-display').innerText = state.survivors;
        document.getElementById('week-display').innerText = state.week;
        document.getElementById('day-display').innerText = days[state.dayIndex];
    }

    function updateRanking() {
        const list = document.getElementById('ranking-list');
        list.innerHTML = '';
        let fullList = [];
        npcList.forEach(name => {
            fullList.push({ name: name, candies: state.npcScores[name], isPlayer: false });
        });
        fullList.push({ name: state.playerName, candies: state.candies, isPlayer: true });
        fullList.sort((a,b) => b.candies - a.candies);
        fullList.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = `ranking-item ${item.isPlayer ? 'player' : ''}`;
            div.innerHTML = `<span>${i+1}. ${item.name}</span><span>${item.candies}🍬</span>`;
            list.appendChild(div);
        });
    }

    function typeWriter(text, elementId, callback) {
        const el = document.getElementById(elementId);
        el.innerHTML = "";
        let i = 0;
        const speed = 30 / state.gameSpeed;
        function type() {
            if (i < text.length) {
                el.innerHTML += text.charAt(i);
                i++;
                setTimeout(type, speed);
            } else if (callback) { callback(); }
        }
        type();
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function startTurn() {
        if (state.isGameOver) return;
        if (state.dayIndex >= days.length) { processFriday(); return; }
        
        updateUI();
        updateRanking();

        npcList.forEach(name => {
            const gain = Math.floor(Math.random()*15) * state.difficultyMults[state.difficulty];
            state.npcScores[name] += Math.round(gain);
        });

        const pool = commonEvents.concat(mgEvents);
        const ev = pool[Math.floor(Math.random() * pool.length)];
        
        document.getElementById('choices-container').innerHTML = '';
        typeWriter(ev.text, 'message-window', () => {
            const shuffledChoices = shuffleArray([...ev.choices]);
            shuffledChoices.forEach((c) => {
                const btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerText = c.text;
                btn.onclick = () => handleChoice(c);
                document.getElementById('choices-container').appendChild(btn);
            });
        });
    }

    function handleChoice(choice) {
        document.getElementById('choices-container').innerHTML = '';
        const luck = Math.random();
        let mult = 1.0; let prefix = "";
        
        if (luck > 0.85) { mult = 1.5; prefix = "【クリティカル！】 "; }
        else if (luck < 0.15) { mult = 0.5; prefix = "【不運……】 "; }

        const cGained = Math.round(choice.candy * mult);
        state.candies += cGained;
        state.dayIndex++;

        if (cGained < 0) flashRed();
        
        const resultMsg = `${prefix}${choice.msg} <br>（飴: ${cGained >= 0 ? '+' : ''}${cGained}）`;
        typeWriter(resultMsg, 'message-window', () => {
            setTimeout(startTurn, 1500 / state.gameSpeed);
        });
    }

    function processFriday() {
        document.getElementById('game-main').classList.add('glitch-anim');
        setTimeout(() => {
            document.getElementById('game-main').classList.remove('glitch-anim');

            let finalScores = npcList.map(name => ({ name, candies: state.npcScores[name], isPlayer: false }));
            finalScores.push({ name: state.playerName, candies: state.candies, isPlayer: true });
            finalScores.sort((a,b) => a.candies - b.candies);

            if (finalScores.length <= 2) {
                const survivorsList = finalScores.map(f => f.name).join('、');
                triggerFav(`第${state.week}週の集計が終わったぽん。残りは${finalScores.length}名（${survivorsList}）だぽん。ゲームはここで終了だぽん！`, () => {
                    endGameFinal(finalScores);
                });
                return;
            }

            const victim = finalScores[0];

            if (victim.isPlayer) {
                gameOver();
                return;
            } else {
                npcList = npcList.filter(n => n !== victim.name);
                delete state.npcScores[victim.name];
                state.survivors--;
                updateRanking();

                const murderRoll = Math.random();
                if (murderRoll < 0.10 && (npcList.length + 1) >= 2) {
                    const remaining = npcList.slice();
                    remaining.push(state.playerName);
                    const killerIdx = Math.floor(Math.random() * remaining.length);
                    const killer = remaining[killerIdx];

                    let murderBaseMsg = `第${state.week}週の集計が終わったぽん。最下位は【${victim.name}】だぽん。消去したぽん。<br>`;

                    // プレイヤーがキラーになった場合、選択肢を出す
                    if (killer === state.playerName) {
                        typeWriter(murderBaseMsg + "……おや、君の中にドス黒い衝動が湧き上がったぽん。誰を「処理」するぽん？", 'message-window', () => {
                            document.getElementById('choices-container').innerHTML = '';
                            npcList.forEach(targetName => {
                                const btn = document.createElement('button');
                                btn.className = 'choice-btn';
                                btn.innerText = `【殺害】${targetName}`;
                                btn.onclick = () => executeMurder(killer, targetName, murderBaseMsg);
                                document.getElementById('choices-container').appendChild(btn);
                            });
                        });
                    } else {
                        // NPCがキラーの場合（従来通り）
                        const targets = remaining.filter(n => n !== killer);
                        const target = targets[Math.floor(Math.random() * targets.length)];
                        executeMurder(killer, target, murderBaseMsg);
                    }
                } else {
                    state.week++;
                    state.dayIndex = 0;
                    triggerFav(`第${state.week-1}週の集計が終わったぽん。最下位は【${victim.name}】だぽん。消去したぽん。<br>来週も飴を集めまくるぽん！`, startTurn);
                }
            }
        }, 2000 / state.gameSpeed);
    }

    function executeMurder(killer, target, baseMsg) {
        document.getElementById('choices-container').innerHTML = '';
        let murderMsg = baseMsg + `その後、【${killer}】が【${target}】を殺したぽん！`;

        if (target === state.playerName) {
            triggerFav(murderMsg, () => {
                gameOver();
            });
            return;
        } else {
            npcList = npcList.filter(n => n !== target);
            delete state.npcScores[target];
            state.survivors--;
            updateRanking();

            let survivorsNow = npcList.length + 1;
            if (survivorsNow <= 2) {
                const survivorsList = npcList.concat(state.playerName).join('、');
                triggerFav(murderMsg + `<br>現在残りは${survivorsNow}名（${survivorsList}）。ゲームを終了するぽん。`, () => {
                    endGameFinal(
                        (npcList.map(n => ({ name: n, isPlayer: false, candies: state.npcScores[n] })))
                        .concat([{ name: state.playerName, isPlayer: true, candies: state.candies }])
                    );
                });
            } else {
                state.week++;
                state.dayIndex = 0;
                triggerFav(murderMsg, startTurn);
            }
        }
    }

    function endGameFinal(finalList) {
        state.isGameOver = true;
        const survivorsNames = finalList.map(f => f.name).join('、');
        document.getElementById('game-main').innerHTML = `
            <div style="text-align:center; margin-top:120px">
                <h1 style="font-size:2.5rem">GAME END</h1>
                <p>残りの魔法少女: ${survivorsNames}</p>
                <p>二人になったのでここで終了だぽん！</p>
                <button class="restart-btn" onclick="location.reload()">タイトルに戻る</button>
            </div>
        `;
    }

    function triggerFav(msg, cb) {
        document.getElementById('fav-message').innerHTML = msg;
        document.getElementById('fav-popup').style.display = 'block';
        window.favCb = cb;
    }
    
    function closeFav() {
        document.getElementById('fav-popup').style.display = 'none';
        if(window.favCb) { window.favCb(); window.favCb = null; }
    }

    function flashRed() {
        const m = document.getElementById('game-main');
        m.classList.remove('flash-red-anim');
        void m.offsetWidth;
        m.classList.add('flash-red-anim');
    }

    function gameOver() {
        state.isGameOver = true;
        document.getElementById('game-main').innerHTML = `
            <div style="text-align:center; margin-top:150px">
                <h1 class="glitch-anim" style="font-size:3rem">SYSTEM PURGE</h1>
                <p>あなたは最下位になったか、殺害されました。</p>
                <p style="color:red">魔法少女の資格を失い、消去されます...</p>
                <button class="restart-btn" onclick="location.reload()">タイトルに戻る</button>
            </div>
        `;
    }
</script>
</body>
</html>